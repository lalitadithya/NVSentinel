# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Prepare Environment

on:
  workflow_call:
    outputs:
      safe_ref_name:
        description: 'Safe reference name for container tags'
        value: ${{ jobs.prepare-vars.outputs.safe_ref_name }}
      nvcr_container_repo:
        description: 'Container registry URL'
        value: ${{ jobs.prepare-vars.outputs.nvcr_container_repo }}
      container_org:
        description: 'Container organization'
        value: ${{ jobs.prepare-vars.outputs.container_org }}
      # Tool versions outputs
      go_version:
        description: 'Go version'
        value: ${{ jobs.prepare-vars.outputs.go_version }}
      python_version:
        description: 'Python version'
        value: ${{ jobs.prepare-vars.outputs.python_version }}
      poetry_version:
        description: 'Poetry version'
        value: ${{ jobs.prepare-vars.outputs.poetry_version }}
      golangci_lint_version:
        description: 'golangci-lint version'
        value: ${{ jobs.prepare-vars.outputs.golangci_lint_version }}
      protobuf_version:
        description: 'Protocol Buffers version'
        value: ${{ jobs.prepare-vars.outputs.protobuf_version }}
      protoc_gen_go_version:
        description: 'protoc-gen-go version'
        value: ${{ jobs.prepare-vars.outputs.protoc_gen_go_version }}
      protoc_gen_go_grpc_version:
        description: 'protoc-gen-go-grpc version'
        value: ${{ jobs.prepare-vars.outputs.protoc_gen_go_grpc_version }}
      grpcio_tools_version:
        description: 'grpcio-tools version'
        value: ${{ jobs.prepare-vars.outputs.grpcio_tools_version }}
      shellcheck_version:
        description: 'shellcheck version'
        value: ${{ jobs.prepare-vars.outputs.shellcheck_version }}

env:
  # Container settings
  CONTAINER_REGISTRY: ghcr.io
  CONTAINER_ORG: ${{ github.repository_owner }}

  # Centralized tool versions - single source of truth
  GO_VERSION: '1.24'
  PYTHON_VERSION: '3.11'
  POETRY_VERSION: '1.8.2'
  GOLANGCI_LINT_VERSION: 'v1.64.8'
  PROTOBUF_VERSION: 'v27.1'
  PROTOC_GEN_GO_VERSION: 'v1.36.6'
  PROTOC_GEN_GO_GRPC_VERSION: 'v1.3.0'
  GRPCIO_TOOLS_VERSION: '1.75.1'
  SHELLCHECK_VERSION: 'v0.11.0'

jobs:
  prepare-vars:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      safe_ref_name: ${{ steps.prepare.outputs.safe_ref_name }}
      nvcr_container_repo: ${{ steps.prepare.outputs.nvcr_container_repo }}
      container_org: ${{ steps.prepare.outputs.container_org }}
      # Tool version outputs
      go_version: ${{ env.GO_VERSION }}
      python_version: ${{ env.PYTHON_VERSION }}
      poetry_version: ${{ env.POETRY_VERSION }}
      golangci_lint_version: ${{ env.GOLANGCI_LINT_VERSION }}
      protobuf_version: ${{ env.PROTOBUF_VERSION }}
      protoc_gen_go_version: ${{ env.PROTOC_GEN_GO_VERSION }}
      protoc_gen_go_grpc_version: ${{ env.PROTOC_GEN_GO_GRPC_VERSION }}
      grpcio_tools_version: ${{ env.GRPCIO_TOOLS_VERSION }}
      shellcheck_version: ${{ env.SHELLCHECK_VERSION }}
    steps:
      - uses: actions/checkout@v4
      - name: Prepare variables
        id: prepare
        uses: ./.github/actions/prepare-vars